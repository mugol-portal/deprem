<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® MuG√∂l Sismik Radar | Premium</title>
    
    <!-- Nunito Yazƒ± Tipi -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Harita (Leaflet.js) K√ºt√ºphaneleri -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            /* Premium Dark Theme Colors */
            --bg-dark: #07090e;
            --panel-bg: rgba(15, 23, 42, 0.75);
            --panel-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.4);
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --location: #6366f1;
            --glass-blur: blur(20px);
            --card-bg: rgba(30, 41, 59, 0.5);
            --card-hover: rgba(30, 41, 59, 0.8);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Nunito', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Cam Efektli √úst Bilgi */
        header { 
            background: var(--panel-bg); 
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: 16px 24px; 
            border-bottom: 1px solid var(--panel-border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: nowrap; /* Hamburger men√ºy√º saƒüda tutmak i√ßin */
            position: relative; 
            z-index: 1000; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); 
        }
        
        .logo { 
            font-size: 22px; 
            font-weight: 900; 
            color: var(--text-main); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            letter-spacing: 0.5px; 
        }
        .logo svg {
            color: var(--accent);
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }
        .logo span { 
            color: var(--text-muted); 
            font-size: 14px; 
            font-weight: 600; 
            letter-spacing: 0; 
            border-left: 1px solid var(--panel-border);
            padding-left: 10px;
        }

        /* Mobil Ekranlarda Logo Metnini K√º√ß√ºlt */
        @media (max-width: 600px) {
            .logo span { display: none; }
            .logo { font-size: 20px; }
        }

        /* Yenileme Geri Sayƒ±m √áubuƒüu (Neon Effect) */
        #progressContainer { 
            width: 100%; height: 2px; 
            background: rgba(255,255,255,0.05); 
            position: absolute; bottom: 0; left: 0; 
        }
        #progressBar { 
            height: 100%; width: 0%; 
            background: var(--accent); 
            transition: width 1s linear; 
            box-shadow: 0 0 10px var(--accent);
        }

        /* Hamburger Men√º Butonu */
        .menu-btn {
            background: transparent; 
            color: var(--text-main); 
            border: none; 
            padding: 6px;
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s ease;
        }
        .menu-btn:hover { 
            background: rgba(255,255,255,0.1); 
            color: var(--accent); 
            transform: scale(1.05); 
        }

        /* SAƒûDAN A√áILIR MEN√ú (OFFCANVAS) */
        .settings-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px);
            z-index: 10001; opacity: 0; pointer-events: none; transition: 0.4s ease;
        }
        .settings-overlay.active { opacity: 1; pointer-events: auto; }

        .settings-panel {
            position: fixed; top: 0; right: -380px; width: 360px; height: 100vh;
            background: rgba(11, 15, 25, 0.95); 
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            z-index: 10002; transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -10px 0 40px rgba(0,0,0,0.8); 
            display: flex; flex-direction: column; 
            border-left: 1px solid var(--panel-border);
        }
        .settings-panel.active { right: 0; }

        .settings-header {
            padding: 24px; 
            border-bottom: 1px solid var(--panel-border); 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.02);
        }
        .settings-header h2 { font-size: 18px; font-weight: 800; color: var(--text-main); }
        .close-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid transparent; 
            color: var(--text-muted); width: 32px; height: 32px; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; transition: 0.3s; 
        }
        .close-btn:hover { 
            background: rgba(239, 68, 68, 0.1); color: var(--danger); 
            border-color: rgba(239, 68, 68, 0.3); transform: rotate(90deg);
        }

        .settings-content { padding: 24px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; flex: 1; }
        .settings-content::-webkit-scrollbar { width: 4px; }
        .settings-content::-webkit-scrollbar-track { background: transparent; }
        .settings-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* Men√º ƒ∞√ßi Ara√ßlar */
        .control-group-vertical { display: flex; flex-direction: column; gap: 8px; font-size: 13px; color: var(--text-muted); font-weight: 700; }
        select, input[type="text"], input[type="number"] {
            background: rgba(0,0,0,0.3); color: white; border: 1px solid var(--panel-border); width: 100%;
            padding: 12px 16px; border-radius: 10px; outline: none; transition: all 0.3s; font-weight: 600; font-size: 14px;
        }
        select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15); background: rgba(0,0,0,0.5); }
        select option { background: #0f172a; color: #fff; }

        .btn-location {
            background: linear-gradient(135deg, var(--location), #4f46e5); color: white; border: none; padding: 14px 20px; width: 100%;
            border-radius: 10px; font-weight: 800; font-size: 14px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-location:hover { box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5); transform: translateY(-2px); }

        .btn-tool {
            background: rgba(255,255,255,0.03); color: #e2e8f0; border: 1px solid var(--panel-border); padding: 12px 15px; width: 100%;
            border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 13px; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-tool:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.2); }
        .btn-tool.active { background: rgba(16, 185, 129, 0.15); color: var(--success); border-color: var(--success); }
        
        .btn-test { background: rgba(245, 158, 11, 0.1); color: var(--warning); border-color: rgba(245, 158, 11, 0.3); }
        .btn-test:hover { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border-color: var(--warning); }

        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tools-grid-full { grid-template-columns: 1fr; margin-top: -10px; }

        /* ƒ∞statistik √áubuƒüu */
        .stats-bar { 
            background: rgba(11, 15, 25, 0.6); 
            backdrop-filter: blur(10px);
            padding: 12px 28px; display: flex; flex-wrap: wrap; gap: 20px 40px; 
            border-bottom: 1px solid var(--panel-border); font-size: 13px; position: relative; z-index: 999; 
        }
        .stat-item { display: flex; gap: 8px; align-items: center; font-weight: 600; color: var(--text-muted); }
        .stat-value { font-weight: 900; color: var(--text-main); font-size: 15px; background: rgba(255,255,255,0.05); padding: 2px 10px; border-radius: 6px; border: 1px solid var(--panel-border); }
        .stat-value.danger { color: var(--danger); border-color: rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.1); }

        /* Kaydƒ±rma ve Alanlar */
        .dashboard { display: flex; flex: 1; min-height: 0; position: relative; }

        /* Sol Liste (Depremler) */
        .sidebar { 
            width: 440px; 
            background: var(--panel-bg); 
            backdrop-filter: blur(16px);
            border-right: 1px solid var(--panel-border); 
            display: flex; flex-direction: column; min-height: 0; position: relative; z-index: 998; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.3); 
        }
        
        .sidebar-header { 
            padding: 18px 24px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--panel-border); 
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; 
        }
        .sidebar-header-title { font-weight: 800; color: var(--text-main); font-size: 15px; }
        
        .status-indicator { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); font-weight: 700; background: rgba(255,255,255,0.05); padding: 4px 12px; border-radius: 20px; }
        .status-dot { height: 8px; width: 8px; background-color: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .eq-list { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 50px; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }
        
        .eq-list::-webkit-scrollbar { width: 5px; }
        .eq-list::-webkit-scrollbar-track { background: transparent; }
        .eq-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .eq-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* Premium Deprem Kartlarƒ± - D√úZELTƒ∞LMƒ∞≈û YAPI */
        .eq-card {
            background: var(--card-bg); 
            padding: 16px; 
            border-radius: 14px;
            display: flex; 
            align-items: flex-start; /* Sƒ±kƒ±≈ümayƒ± engellemek i√ßin esnek ba≈ülangƒ±√ß */
            gap: 16px; 
            border: 1px solid var(--panel-border);
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            position: relative; 
            overflow: hidden; /* Parƒ±ltƒ± efekti i√ßin */
        }
        .eq-card:hover { 
            transform: translateY(-3px); 
            background: var(--card-hover); 
            border-color: rgba(255,255,255,0.15);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); 
        }
        
        /* Kart ƒ∞√ßi Aydƒ±nlatma √áizgisi */
        .eq-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: var(--card-color, gray);
            box-shadow: 0 0 15px var(--card-color, gray);
            border-radius: 4px 0 0 4px;
        }

        /* Yeni Deprem Vurgusu */
        .eq-new { animation: borderPulse 2.5s infinite; border-color: rgba(56, 189, 248, 0.4); }
        @keyframes borderPulse { 0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.3); } 70% { box-shadow: 0 0 0 6px rgba(56, 189, 248, 0); } 100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); } }

        .eq-mag-container {
            width: 55px; height: 55px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0; margin-top: 2px;
        }
        .eq-mag { font-size: 24px; font-weight: 900; letter-spacing: -0.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.5);}
        
        /* Kartƒ±n i√ßeriƒüini saran, ta≈ümayƒ± akƒ±llƒ±ca y√∂neten alan */
        .eq-details { 
            flex: 1; 
            min-width: 0; /* Flex-box i√ßi metin sƒ±kƒ±≈ümasƒ±nƒ± engeller */
            display: flex;
            flex-direction: column;
            gap: 8px; /* Metin ve etiketler arasƒ± bo≈üluk */
        }
        .eq-place { 
            font-size: 15px; font-weight: 800; line-height: 1.4; color: #f8fafc;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;
            margin: 0; /* Tarayƒ±cƒ± kaynaklƒ± margin kaymalarƒ±nƒ± √∂nler */
        }
        .eq-meta { display: flex; flex-wrap: wrap; gap: 6px; font-size: 11px; color: var(--text-muted); font-weight: 700; align-items: center; }
        
        /* Premium Etiketler (Badges) */
        .badge { padding: 4px 8px; border-radius: 6px; border: 1px solid transparent; backdrop-filter: blur(4px); white-space: nowrap; }
        .eq-source { background: rgba(56, 189, 248, 0.1); color: var(--accent); border-color: rgba(56, 189, 248, 0.2); }
        .eq-depth { background: rgba(255, 255, 255, 0.05); color: #cbd5e1; border-color: rgba(255, 255, 255, 0.1); }
        .eq-distance { background: rgba(99, 102, 241, 0.15); color: #818cf8; border-color: rgba(99, 102, 241, 0.25); display: flex; align-items: center; gap: 3px; }
        .eq-intensity { background: rgba(168, 85, 247, 0.15); color: #c084fc; border-color: rgba(168, 85, 247, 0.25); }
        .eq-closest { background: rgba(16, 185, 129, 0.15); color: #34d399; border-color: rgba(16, 185, 129, 0.25); font-weight: 900;}
        .eq-badge-new { background: rgba(56, 189, 248, 0.2); color: #38bdf8; border-color: rgba(56, 189, 248, 0.4); font-weight: 900; letter-spacing: 0.5px;}
        .eq-risk-warning { background: rgba(249, 115, 22, 0.15); color: #fb923c; border-color: rgba(249, 115, 22, 0.3); font-weight: 900; animation: pulse-text 2s infinite;}
        .eq-risk-danger { background: rgba(239, 68, 68, 0.15); color: #f87171; border-color: rgba(239, 68, 68, 0.3); font-weight: 900; animation: pulse-text 1.5s infinite;}
        @keyframes pulse-text { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Harita Alanƒ± */
        #map { flex: 1; background: #05070a; z-index: 1; }
        
        /* Premium Leaflet Popup (Dark & Glassmorphism) */
        .leaflet-popup-content-wrapper { 
            background: rgba(15, 23, 42, 0.85) !important; 
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            color: #f8fafc !important; 
            border: 1px solid rgba(255,255,255,0.1) !important; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.6) !important; 
            border-radius: 16px !important; 
            font-family: 'Nunito', sans-serif !important; 
        }
        .leaflet-popup-tip { background: rgba(15, 23, 42, 0.85) !important; border-top: 1px solid rgba(255,255,255,0.1); border-left: 1px solid rgba(255,255,255,0.1);}
        .leaflet-popup-content { margin: 18px !important; }
        .popup-title { font-size: 15px; font-weight: 800; color: #e2e8f0; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .popup-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #94a3b8; }
        .popup-val { color: #f8fafc; font-weight: 800; }
        .leaflet-container a.leaflet-popup-close-button { color: #94a3b8; padding: 6px; font-size: 18px; font-weight: bold;}
        .leaflet-container a.leaflet-popup-close-button:hover { color: #ef4444; }

        /* Kullanƒ±cƒ± Konum ƒ∞konu */
        .user-marker-pulse { width: 18px; height: 18px; background: #38bdf8; border-radius: 50%; border: 3px solid #0f172a; box-shadow: 0 0 15px #38bdf8; animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); } 
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(56, 189, 248, 0); } 
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); } 
        }

        /* MOBƒ∞L UYUM */
        @media (max-width: 900px) {
            body { height: auto; overflow-y: auto; display: block; }
            .dashboard { display: flex; flex-direction: column-reverse; height: auto; }
            #map { height: 50vh; min-height: 400px; width: 100%; flex: none; border-bottom: 2px solid var(--panel-border); }
            .sidebar { width: 100%; height: auto; border-right: none; box-shadow: none; }
            .eq-list { max-height: 60vh; overflow-y: auto; padding-bottom: 30px;}
            .stats-bar { padding: 12px 20px; justify-content: flex-start; gap: 12px; }
            .settings-panel { width: 300px; right: -300px; }
        }

        /* Premium Sinematik Alarm Aray√ºz√º */
        #alarmOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(220, 38, 38, 0.9) 0%, rgba(153, 27, 27, 0.95) 50%, #450a0a 100%);
            backdrop-filter: blur(10px);
            z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
            animation: cinematicPulse 1s infinite alternate;
        }
        @keyframes cinematicPulse { from { background-color: rgba(220, 38, 38, 0.85); } to { background-color: rgba(185, 28, 28, 0.95); } }
        
        #alarmOverlay h1 { 
            font-size: clamp(36px, 8vw, 64px); font-weight: 900; margin-bottom: 15px; color: #fff;
            text-shadow: 0 10px 30px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.3); 
            animation: shake 0.4s infinite; letter-spacing: 2px; padding: 0 20px;
        }
        #alarmOverlay p { 
            font-size: clamp(18px, 4vw, 26px); font-weight: 700; margin-bottom: 50px; color: #fee2e2; 
            padding: 20px 30px; background: rgba(0,0,0,0.3); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px); width: 90%; max-width: 600px;
        }
        #alarmOverlay button { 
            background: #fff; color: #991b1b; border: none; padding: 20px 40px; 
            font-size: clamp(16px, 3vw, 20px); font-weight: 900; border-radius: 12px; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); letter-spacing: 1px; width: 85%; max-width: 400px;
        }
        #alarmOverlay button:hover { transform: scale(1.05) translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.7); }
        
        @keyframes shake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-3px, 3px) rotate(1deg); }
            50% { transform: translate(3px, -3px) rotate(-1deg); }
            75% { transform: translate(-3px, -3px) rotate(1deg); }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h5l3-9 5 18 3-9h4"/></svg>
        MuG√∂l <span>Sismik Radar</span>
    </div>
    
    <!-- Yeni Hamburger Men√º -->
    <button class="menu-btn" onclick="toggleSettings()" aria-label="Men√º">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <div id="progressContainer"><div id="progressBar"></div></div>
</header>

<div id="settingsOverlay" class="settings-overlay" onclick="toggleSettings()"></div>
<div id="settingsPanel" class="settings-panel">
    <div class="settings-header">
        <h2>Radar Ayarlarƒ±</h2>
        <button class="close-btn" onclick="toggleSettings()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>
    
    <div class="settings-content">
        <button id="btnLocation" class="btn-location" onclick="getUserLocation()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
            Konumumu Haritada Bul
        </button>

        <div class="control-group-vertical">
            <label>üìç Hƒ±zlƒ± Arama:</label>
            <input type="text" id="searchInput" placeholder="≈ûehir veya B√∂lge yazƒ±n...">
        </div>

        <div class="control-group-vertical">
            <label>üó∫Ô∏è G√∂zlem B√∂lgesi:</label>
            <select id="region">
                <option value="tr" selected>T√ºrkiye (Genel G√∂r√ºn√ºm)</option>
                <option value="marmara">üî∏ Marmara B√∂lgesi</option>
                <option value="ege">üî∏ Ege B√∂lgesi</option>
                <option value="akdeniz">üî∏ Akdeniz B√∂lgesi</option>
                <option value="icanadolu">üî∏ ƒ∞√ß Anadolu B√∂lgesi</option>
                <option value="karadeniz">üî∏ Karadeniz B√∂lgesi</option>
                <option value="doguanadolu">üî∏ Doƒüu Anadolu B√∂lgesi</option>
                <option value="guneydogu">üî∏ G√ºneydoƒüu B√∂lgesi</option>
                <option value="local">üéØ Yakƒ±n √áevrem (200km √áap)</option>
                <option value="all">üåç T√ºm D√ºnya (Global)</option>
            </select>
        </div>

        <div class="control-group-vertical">
            <label>‚è±Ô∏è Zaman Aralƒ±ƒüƒ±:</label>
            <select id="timeSpan">
                <option value="all_hour">Son 1 Saat (Aktif ≈ûoklar)</option>
                <option value="all_day" selected>Son 24 Saat (G√ºnl√ºk)</option>
                <option value="all_week">Son 7 G√ºn (Haftalƒ±k Analiz)</option>
            </select>
        </div>

        <div class="control-group-vertical">
            <label>üì° Veri Kaynaƒüƒ±:</label>
            <select id="sourceSelect">
                <option value="all" selected>T√ºm Sens√∂rler (Birle≈üik Veri)</option>
                <option value="bdtim">Kandilli Rasathanesi (BDTIM)</option>
                <option value="afad">AFAD</option>
                <option value="emsc">Avrupa Sismoloji (EMSC)</option>
                <option value="geonet">Yeni Zelanda (GeoNet)</option>
                <option value="usgs">Amerika (USGS)</option>
            </select>
        </div>

        <div class="control-group-vertical">
            <label>‚ö†Ô∏è Kritik Alarm E≈üiƒüi (≈ûiddet):</label>
            <input type="number" id="minMag" value="4.5" step="0.1" min="1.0" title="Belirlenen ≈üiddet ve √ºst√º i√ßin kƒ±rmƒ±zƒ± siren √ßalar">
        </div>

        <div class="tools-grid">
            <button id="btnWakeLock" class="btn-tool" onclick="toggleWakeLock()" title="Ekranƒ±n uyku moduna ge√ßmesini engeller">üëÅÔ∏è G√∂zlem Modu</button>
            <button id="btnFullscreen" class="btn-tool" onclick="toggleFullScreen()" title="Tam Ekran Modu">üî≤ Tam Ekran</button>
        </div>
        
        <!-- YENƒ∞: Test Bildirim √ñzelliƒüi Butonu -->
        <div class="tools-grid tools-grid-full">
            <button id="btnTestAlarm" class="btn-tool btn-test" onclick="testAlarm()" title="Siren ve aray√ºz√º test eder">
                üîî Alarm ve Sireni Test Et
            </button>
        </div>
    </div>
</div>

<div class="stats-bar">
    <div class="stat-item">Tespit Edilen Olay: <span class="stat-value" id="statCount">0</span></div>
    <div class="stat-item">Maksimum B√ºy√ºkl√ºk: <span class="stat-value danger" id="statMax">0.0</span></div>
    <div class="stat-item">Ortalama Derinlik: <span class="stat-value" id="statDepth">0 km</span></div>
    <div class="stat-item" id="userLocationText" style="display:none; color:var(--location);">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        GPS Aktif
    </div>
</div>

<div class="dashboard">
    <div class="sidebar">
        <div class="sidebar-header">
            <div>
                <div class="sidebar-header-title">Canlƒ± Akƒ±≈ü Monit√∂r√º</div>
                <div id="lastUpdateText" style="font-size:11px; color:var(--text-muted); font-weight:600; margin-top: 4px;">Sistem ba≈ülatƒ±lƒ±yor...</div>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Baƒülanƒ±yor</span>
            </div>
        </div>
        <div class="eq-list" id="eqList">
            <div style="text-align:center; padding:50px 20px; color:var(--text-muted); font-weight:700;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:15px; animation: pulse-text 2s infinite;"><path d="M2 12h5l3-9 5 18 3-9h4"/></svg>
                <br>K√ºresel aƒülara ≈üifreli baƒülantƒ± kuruluyor...
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<div id="alarmOverlay">
    <h1>‚ö†Ô∏è KRƒ∞Tƒ∞K DEPREM ALARMI ‚ö†Ô∏è</h1>
    <p id="alarmDetails"></p>
    <button onclick="stopAlarm()">Sƒ∞RENƒ∞ SUSTUR VE DETAYLARI G√ñR</button>
</div>

<script>
    // --- MEN√ú (OFFCANVAS) Sƒ∞STEMƒ∞ ---
    function toggleSettings() {
        document.getElementById('settingsPanel').classList.toggle('active');
        document.getElementById('settingsOverlay').classList.toggle('active');
    }

    // --- SES Sƒ∞STEMƒ∞ (G√ñR√úNMEZ OTOMATƒ∞K BA≈ûLATMA) ---
    let audioCtx;
    let alarmInterval;
    let isAudioEnabled = false;

    // Kullanƒ±cƒ±nƒ±n sistemle ilk etkile≈üiminde sesi g√ºvenilir ≈üekilde ba≈ülatma
    function forceAudioInit() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        isAudioEnabled = true;
    }

    function initAudioOnFirstInteraction() {
        if (!isAudioEnabled) {
            try {
                forceAudioInit();['click', 'touchstart', 'keydown', 'scroll'].forEach(evt => {
                    document.removeEventListener(evt, initAudioOnFirstInteraction);
                });
            } catch (e) {
                console.log("Ses sistemi arka planda bekliyor.");
            }
        }
    }

    window.addEventListener('load', initAudioOnFirstInteraction);['click', 'touchstart', 'keydown', 'scroll'].forEach(evt => {
        document.addEventListener(evt, initAudioOnFirstInteraction, { once: true });
    });

    function playSiren() {
        if(!isAudioEnabled || !audioCtx) return;
        try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.4);
            osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.8);
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 0.1);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.8);
        } catch(e) { console.error("Siren Hatasƒ±", e); }
    }

    let alarmLocation = null;
    function triggerAlarm(eq) {
        document.getElementById('alarmOverlay').style.display = 'flex';
        
        let distText = "";
        if(userLocation) {
            const dist = getDistance(userLocation.lat, userLocation.lng, eq.lat, eq.lng);
            distText = `<br><br><span style="color:#fcd34d; font-size:1.1em;">üìç Sƒ∞ZE OLAN UZAKLIK: ${dist.toFixed(0)} km</span>`;
        }

        document.getElementById('alarmDetails').innerHTML = `B√ºy√ºkl√ºk: <b style="color:#f87171; font-size:1.3em;">${eq.mag.toFixed(1)}</b><br>Kaynak: <b style="color:#94a3b8;">${eq.source}</b><br><br>üó∫Ô∏è ${eq.place} ${distText}`;
        alarmLocation =[eq.lat, eq.lng];
        playSiren();
        alarmInterval = setInterval(playSiren, 900);
    }

    function stopAlarm() {
        document.getElementById('alarmOverlay').style.display = 'none';
        clearInterval(alarmInterval);
        if(alarmLocation) {
            map.flyTo(alarmLocation, 8, { animate: true, duration: 1.5 });
        }
    }

    // --- YENƒ∞: TEST Bƒ∞LDƒ∞Rƒ∞M FONKSƒ∞YONU ---
    function testAlarm() {
        // Ses izni tarayƒ±cƒ± tarafƒ±ndan reddedilmesin diye anƒ±nda tetiklenir
        forceAudioInit();
        
        // Sahte Test Deprem Verisi
        const testEq = {
            mag: 7.4,
            source: "Sƒ∞STEM TESTƒ∞",
            place: "B√ñLGESEL ALARM Sƒ∞STEM TESTƒ∞ - Ger√ßek bir deprem deƒüildir.",
            lat: userLocation ? userLocation.lat : 39.0, // Kullanƒ±cƒ± konumu varsa √ºzerine at
            lng: userLocation ? userLocation.lng : 35.0,
            time: Date.now(),
            depth: 10.0
        };
        
        triggerAlarm(testEq);
        
        // Alarm √ßalarken men√ºy√º arkada kapat
        if(document.getElementById('settingsPanel').classList.contains('active')){
            toggleSettings(); 
        }
    }

    // --- G√ñZLEM MODU (WAKE LOCK API) ---
    let wakeLock = null;
    async function toggleWakeLock() {
        const btn = document.getElementById('btnWakeLock');
        if (wakeLock !== null) {
            await wakeLock.release();
            wakeLock = null;
            btn.classList.remove('active');
            btn.innerHTML = 'üëÅÔ∏è G√∂zlem Modu';
        } else {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                btn.classList.add('active');
                btn.innerHTML = 'üëÅÔ∏è Ekran Uyanƒ±k';
                
                wakeLock.addEventListener('release', () => {
                    if(wakeLock === null) return;
                    wakeLock = null;
                    btn.classList.remove('active');
                    btn.innerHTML = 'üëÅÔ∏è G√∂zlem Modu';
                });
            } catch (err) {
                alert('Tarayƒ±cƒ±nƒ±z G√∂zlem Modunu desteklemiyor.');
            }
        }
    }

    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
            wakeLock = await navigator.wakeLock.request('screen');
        }
    });

    // --- TAM EKRAN MODU ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Tam ekran hatasƒ±: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // --- B√ñLGELER ƒ∞√áƒ∞N KOORDƒ∞NAT VE SINIR TANIMLAMALARI ---
    const regionBounds = {
        tr: { minLat: 34.0, maxLat: 43.0, minLng: 25.0, maxLng: 45.0, center:[39.0, 35.0], zoom: 6 },
        marmara: { minLat: 39.0, maxLat: 42.5, minLng: 25.5, maxLng: 31.5, center:[40.5, 28.5], zoom: 7 },
        ege: { minLat: 36.0, maxLat: 39.5, minLng: 25.0, maxLng: 30.0, center:[38.0, 27.5], zoom: 7 },
        akdeniz: { minLat: 35.5, maxLat: 38.5, minLng: 29.0, maxLng: 37.0, center:[37.0, 32.5], zoom: 7 },
        icanadolu: { minLat: 37.0, maxLat: 40.5, minLng: 30.5, maxLng: 37.5, center:[39.0, 34.0], zoom: 7 },
        karadeniz: { minLat: 40.0, maxLat: 42.5, minLng: 31.0, maxLng: 42.0, center:[41.0, 36.5], zoom: 6 },
        doguanadolu: { minLat: 37.0, maxLat: 41.5, minLng: 37.5, maxLng: 44.5, center:[39.0, 41.0], zoom: 6 },
        guneydogu: { minLat: 36.5, maxLat: 38.5, minLng: 37.0, maxLng: 43.0, center:[37.5, 40.0], zoom: 7 }
    };

    // --- HARƒ∞TA Sƒ∞STEMƒ∞ (LEAFLET) ---
    const map = L.map('map', { zoomControl: false }).setView(regionBounds.tr.center, regionBounds.tr.zoom);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'MuG√∂l Radar' }).addTo(map);
    const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
    
    const faultLinesLayer = L.layerGroup();
    fetch('https://raw.githubusercontent.com/fraxen/tectonicplates/master/GeoJSON/PB2002_boundaries.json')
        .then(res => res.json())
        .then(data => {
            L.geoJSON(data, {
                style: { color: '#ef4444', weight: 1.5, opacity: 0.5, dashArray: '4, 6' }
            }).addTo(faultLinesLayer);
        }).catch(err => console.log('Fay hatlarƒ± verisi √ßekilemedi.'));

    L.control.layers(
        { "Karanlƒ±k Radar": darkMap, "Uydu G√∂r√ºn√ºm√º": satelliteMap }, 
        { "üî¥ K√ºresel Fay Hatlarƒ±": faultLinesLayer },
        { position: 'bottomleft' }
    ).addTo(map);

    let mapMarkers =[];

    // --- KONUM Sƒ∞STEMƒ∞ ---
    let userLocation = null;
    let userMarkerLayer = null;

    function getUserLocation() {
        const btn = document.getElementById('btnLocation');
        btn.innerHTML = '‚è≥ ƒ∞zin Bekleniyor...';
        btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)'; 
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    
                    if (userMarkerLayer) map.removeLayer(userMarkerLayer);
                    
                    const userIcon = L.divIcon({ className: 'user-marker-pulse', iconSize:[18, 18] });
                    userMarkerLayer = L.marker([userLocation.lat, userLocation.lng], {icon: userIcon, zIndexOffset: 1000})
                        .addTo(map)
                        .bindPopup('<b style="color:var(--accent); font-size:14px;">Merkez Konumunuz</b><br><span style="color:#94a3b8">Radar artƒ±k size odaklƒ± hesaplama yapƒ±yor.</span>');
                    
                    map.flyTo([userLocation.lat, userLocation.lng], 8, { animate: true, duration: 1.5 });
                    
                    btn.innerHTML = '‚úì GPS Baƒülantƒ±sƒ± Aktif';
                    btn.style.background = 'linear-gradient(135deg, var(--success), #059669)';
                    document.getElementById('userLocationText').style.display = 'flex';
                    
                    fetchEarthquakes(true);
                    
                    if(window.innerWidth < 900) toggleSettings();
                },
                (error) => {
                    alert("Konum izni reddedildi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan izin verin.");
                    btn.innerHTML = '‚ùå ƒ∞zin Reddedildi';
                    btn.style.background = 'linear-gradient(135deg, var(--danger), #b91c1c)';
                    setTimeout(() => {
                        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> Konumumu Haritada Bul';
                        btn.style.background = 'linear-gradient(135deg, var(--location), #4f46e5)';
                    }, 3000);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            alert("Tarayƒ±cƒ±nƒ±z konum √∂zelliƒüini desteklemiyor.");
            btn.innerHTML = 'üìç Konum Bulunamadƒ±';
        }
    }

    // --- YARDIMCI FONKSƒ∞YONLAR ---
    function titleCase(str) {
        if(!str) return "Bilinmeyen Konum";
        return str.toLocaleLowerCase('tr-TR').split(' ').map(w => w.charAt(0).toLocaleUpperCase('tr-TR') + w.slice(1)).join(' ');
    }

    function translatePlace(place) {
        if (!place) return "Bilinmeyen Konum";
        return place.replace(/Turkey/gi, "T√ºrkiye").replace(/Greece/gi, "Yunanistan").replace(/Syria/gi, "Suriye")
            .replace(/Iran/gi, "ƒ∞ran").replace(/Iraq/gi, "Irak").replace(/Cyprus/gi, "Kƒ±brƒ±s").replace(/of/gi, "")
            .replace(/Central/gi, "Orta").replace(/Western/gi, "Batƒ±").replace(/Eastern/gi, "Doƒüu")
            .replace(/Northern/gi, "Kuzey").replace(/Southern/gi, "G√ºney")
            .replace(/km/gi, "km").replace(/ N /gi, " Kuzeyi ").replace(/ S /gi, " G√ºneyi ")
            .replace(/ E /gi, " Doƒüusu ").replace(/ W /gi, " Batƒ±sƒ± ").trim();
    }

    function parseApiDate(dateStr) {
        if (!dateStr) return Date.now();
        if (dateStr.includes('T')) {
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? Date.now() : d.getTime();
        }
        let cleanDate = dateStr.replace(/\./g, '-');
        const parts = cleanDate.split(' ');
        if (parts.length === 2) {
            const iso = `${parts[0]}T${parts[1]}+03:00`; 
            const d = new Date(iso);
            if (!isNaN(d.getTime())) return d.getTime();
        }
        let safariSafe = cleanDate.replace(/-/g, '/');
        const fallback = new Date(safariSafe).getTime();
        return isNaN(fallback) ? Date.now() : fallback;
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180; 
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function getColor(mag) {
        if(mag < 3.0) return '#10b981'; 
        if(mag < 4.0) return '#f59e0b'; 
        if(mag < 5.0) return '#f97316'; 
        if(mag < 6.0) return '#ef4444'; 
        return '#a855f7'; 
    }

    function getIntensity(mag) {
        if(mag < 3.0) return 'Seviye 1-2 (Hafif)';
        if(mag < 4.0) return 'Seviye 3 (Hissedilir)';
        if(mag < 5.0) return 'Seviye 4-5 (Orta)';
        if(mag < 6.0) return 'Seviye 6-7 (G√º√ßl√º)';
        return 'Seviye 8+ (Yƒ±kƒ±cƒ±)';
    }

    function formatDate(time) {
        const d = new Date(time);
        return d.toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'}) + ' ‚àô ' + d.toLocaleDateString('tr-TR');
    }

    window.flyToLocation = function(lat, lng) {
        map.flyTo([lat, lng], 10, { animate: true, duration: 1.5 });
        if(window.innerWidth < 900 && document.getElementById('settingsPanel').classList.contains('active')) {
            toggleSettings();
        }
    }

    // --- DEPREM ALGORƒ∞TMASI VE Fƒ∞LTRELER ---
    let seenIds = new Set();
    const regionSelect = document.getElementById('region');
    const timeSpanSelect = document.getElementById('timeSpan');
    const sourceSelect = document.getElementById('sourceSelect');
    const minMagInput = document.getElementById('minMag');
    const searchInput = document.getElementById('searchInput'); 
    const eqListEl = document.getElementById('eqList');

    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            eqListEl.innerHTML = '<div style="text-align:center; padding:50px 20px; color:var(--text-muted); font-weight:700;">Veritabanƒ±nda aranƒ±yor...</div>';
            fetchEarthquakes(true);
        }, 500);
    });[regionSelect, timeSpanSelect, sourceSelect].forEach(el => {
        el.addEventListener('change', () => {
            if(el.id === 'region') {
                const val = regionSelect.value;
                if(regionBounds[val]) {
                    map.flyTo(regionBounds[val].center, regionBounds[val].zoom);
                }
                else if(val === 'local') {
                    if(!userLocation) { alert("√ñnce 'Konumumu Bul' butonuna tƒ±klayarak GPS izni verin."); regionSelect.value = 'tr'; return; }
                    map.flyTo([userLocation.lat, userLocation.lng], 7);
                }
                else { map.flyTo([20.0, 0.0], 2); } 
            }
            eqListEl.innerHTML = '<div style="text-align:center; padding:50px 20px; color:var(--text-muted); font-weight:700;">Radar yeniden kalibre ediliyor...</div>';
            fetchEarthquakes(true);
        });
    });

    function updateStats(features) {
        document.getElementById('statCount').innerText = features.length;
        if(features.length > 0) {
            const maxMag = Math.max(...features.map(f => f.mag || 0)).toFixed(1);
            document.getElementById('statMax').innerText = maxMag;
            const totalDepth = features.reduce((sum, f) => sum + (f.depth || 0), 0);
            document.getElementById('statDepth').innerText = (totalDepth / features.length).toFixed(1) + " km";
        } else {
            document.getElementById('statMax').innerText = "0.0";
            document.getElementById('statDepth').innerText = "0 km";
        }
        document.getElementById('lastUpdateText').innerText = "Son Senkronizasyon: " + new Date().toLocaleTimeString('tr-TR');
    }

    function renderData(features, isInit) {
        const previousScroll = eqListEl.scrollTop;
        eqListEl.innerHTML = '';
        mapMarkers.forEach(marker => map.removeLayer(marker));
        mapMarkers =[];

        updateStats(features);

        if(features.length === 0) {
            eqListEl.innerHTML = '<div style="text-align:center; padding:50px 20px; color:var(--text-muted); font-weight:700;">Belirtilen kriterlerde sismik aktivite bulunamadƒ±.</div>';
            return;
        }

        let closestEqId = null;
        if (userLocation && features.length > 0) {
            let minDistance = Infinity;
            features.forEach(eq => {
                if (!isNaN(eq.lat) && !isNaN(eq.lng)) {
                    let d = getDistance(userLocation.lat, userLocation.lng, eq.lat, eq.lng);
                    if (d < minDistance) {
                        minDistance = d;
                        closestEqId = eq.id;
                    }
                }
            });
        }

        const fragment = document.createDocumentFragment();
        const nowMs = Date.now();

        features.slice(0, 80).forEach((eq) => { 
            const mag = (eq.mag || 0).toFixed(1);
            const color = getColor(eq.mag);
            const intensity = getIntensity(eq.mag);
            
            const isFresh = (nowMs - eq.time) < (15 * 60 * 1000); 

            let extraTagsHtml = '';
            
            if (isFresh) {
                extraTagsHtml += `<span class="badge eq-badge-new">‚ú® YENƒ∞</span>`;
            }
            if (userLocation) {
                const dist = getDistance(userLocation.lat, userLocation.lng, eq.lat, eq.lng);
                extraTagsHtml += `<span class="badge eq-distance">üéØ Size: ${dist.toFixed(0)} km</span>`;
            }
            if (eq.id === closestEqId) {
                extraTagsHtml += `<span class="badge eq-closest">üìç En Yakƒ±n</span>`;
            }
            if (eq.mag >= 6.5) {
                extraTagsHtml += `<span class="badge eq-risk-danger">üåä Tsunami Riski</span>`;
            } else if (eq.mag >= 5.5) {
                extraTagsHtml += `<span class="badge eq-risk-warning">‚ö†Ô∏è Hasar Riski</span>`;
            }

            const card = document.createElement('div');
            card.className = `eq-card ${isFresh ? 'eq-new' : ''}`;
            card.style.setProperty('--card-color', color);
            card.onclick = () => flyToLocation(eq.lat, eq.lng);
            card.innerHTML = `
                <div class="eq-mag-container">
                    <div class="eq-mag" style="color: ${color}">${mag}</div>
                </div>
                <div class="eq-details">
                    <div class="eq-place" title="${eq.place}">${eq.place}</div>
                    <div class="eq-meta">
                        <span class="badge eq-source">${eq.source}</span>
                        <span style="white-space:nowrap;">${formatDate(eq.time)}</span>
                        <span class="badge eq-depth">‚è¨ ${eq.depth.toFixed(1)} km</span>
                        ${eq.mag >= 4.0 ? `<span class="badge eq-intensity">${intensity.split(' ')[1]}</span>` : ''}
                        ${extraTagsHtml}
                    </div>
                </div>
            `;
            fragment.appendChild(card);

            if (isNaN(eq.lat) || isNaN(eq.lng) || eq.lat === 0 || eq.lng === 0) return;

            const validMag = eq.mag > 0 ? eq.mag : 1;
            const radius = Math.max((validMag ** 2) * 1200, 10000); 
            const marker = L.circle([eq.lat, eq.lng], {
                radius: radius, fillColor: color, color: color, weight: 2, opacity: 0.9, fillOpacity: 0.35
            }).addTo(map);

            if (eq.mag >= 4.0) {
                const feltRadius = (eq.mag ** 2) * 4500;
                const feltMarker = L.circle([eq.lat, eq.lng], {
                    radius: feltRadius, fillColor: color, color: color, weight: 1, opacity: 0.4, fillOpacity: 0.05, dashArray: '5, 5'
                }).addTo(map);
                mapMarkers.push(feltMarker);
            }

            let popupDistance = userLocation ? `<div class="popup-row"><span>Mesafe (GPS):</span> <span class="popup-val" style="color:var(--warning)">${getDistance(userLocation.lat, userLocation.lng, eq.lat, eq.lng).toFixed(1)} km</span></div>` : '';

            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <div style="text-align:center; margin-bottom:15px;">
                        <span style="display:inline-block; font-size:32px; font-weight:900; color:${color}; line-height:1; text-shadow:0 0 15px ${color};">${mag}</span>
                    </div>
                    <div class="popup-title">${eq.place}</div>
                    <div class="popup-row"><span>Derinlik:</span> <span class="popup-val">${eq.depth.toFixed(1)} km</span></div>
                    <div class="popup-row"><span>Etki:</span> <span class="popup-val" style="color:#c084fc;">${intensity}</span></div>
                    <div class="popup-row"><span>Aƒü:</span> <span class="popup-val">${eq.source}</span></div>
                    <div class="popup-row"><span>Zaman:</span> <span class="popup-val">${formatDate(eq.time)}</span></div>
                    ${popupDistance}
                </div>
            `);
            mapMarkers.push(marker);
        });

        if (features.length > 80) {
            const footer = document.createElement('div');
            footer.style.textAlign = 'center'; footer.style.padding = '20px';
            footer.style.color = 'var(--text-muted)'; footer.style.fontSize = '12px'; footer.style.fontWeight = 'bold';
            footer.innerText = `...ve ${features.length - 80} eski kayƒ±t performans optimizasyonu i√ßin gizlendi.`;
            fragment.appendChild(footer);
        }

        eqListEl.appendChild(fragment);
        if (!isInit) eqListEl.scrollTop = previousScroll;
    }

    // --- APƒ∞ √áEKME & G√úVENLƒ∞K Fƒ∞LTRESƒ∞ ---
    async function fetchEarthquakes(isInit = false) {
        try {
            document.getElementById('statusText').innerText = "Veri √áekiliyor...";
            document.getElementById('statusDot').style.backgroundColor = "var(--warning)";
            document.getElementById('statusDot').style.boxShadow = "0 0 10px var(--warning)";

            const timeFilter = timeSpanSelect.value;
            let usgsEndpoint = 'all_day.geojson';
            if(timeFilter === 'all_hour') usgsEndpoint = 'all_hour.geojson';
            if(timeFilter === 'all_week') usgsEndpoint = 'all_week.geojson';

            // 5 Farklƒ± G√ºvenilir Kaynaktan Veri √áekimi
            const[usgsRes, bdtimRes, afadRes, emscRes, geonetRes] = await Promise.allSettled([
                fetch(`https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/${usgsEndpoint}`).then(r=>r.json()),
                fetch('https://api.orhanaydogdu.com.tr/deprem/kandilli/live?limit=200').then(r=>r.json()),
                fetch('https://api.orhanaydogdu.com.tr/deprem/afad/live?limit=200').then(r=>r.json()),
                fetch('https://www.seismicportal.eu/fdsnws/event/1/query?limit=200&format=json').then(r=>r.json()),
                fetch('https://api.geonet.org.nz/quake?MMI=-1').then(r=>r.json())
            ]);

            let allEqs =[];

            const parseData = (res, sourceName) => {
                if (res.status !== 'fulfilled' || !res.value) return[];
                
                let data =[];
                if (sourceName === 'USGS' || sourceName === 'EMSC' || sourceName === 'GEONET') {
                    data = res.value.features ||[];
                } else {
                    data = res.value.result ||[];
                }

                if (!Array.isArray(data)) return[];

                return data.map(f => {
                    try {
                        let lat, lng, id, mag, place, time, depth;

                        if (sourceName === 'USGS') {
                            lat = parseFloat(f.geometry?.coordinates?.[1]);
                            lng = parseFloat(f.geometry?.coordinates?.[0]);
                            id = 'U_' + f.id;
                            mag = parseFloat(f.properties.mag) || 0;
                            place = translatePlace(f.properties.place);
                            time = f.properties.time; 
                            depth = parseFloat(f.geometry?.coordinates?.[2] || 0);
                        } 
                        else if (sourceName === 'EMSC') {
                            lat = parseFloat(f.geometry?.coordinates?.[1]);
                            lng = parseFloat(f.geometry?.coordinates?.[0]);
                            id = 'E_' + (f.properties.unid || f.id);
                            mag = parseFloat(f.properties.mag) || 0;
                            place = titleCase(translatePlace(f.properties.flynn_region || f.properties.region || "Bilinmeyen Konum"));
                            time = parseApiDate(f.properties.time); 
                            depth = parseFloat(f.properties.depth || f.geometry?.coordinates?.[2] || 0);
                        } 
                        else if (sourceName === 'GEONET') {
                            lat = parseFloat(f.geometry?.coordinates?.[1]);
                            lng = parseFloat(f.geometry?.coordinates?.[0]);
                            id = 'G_' + (f.properties.publicID || f.id);
                            mag = parseFloat(f.properties.magnitude) || 0;
                            place = titleCase(translatePlace(f.properties.locality || "Yeni Zelanda"));
                            time = parseApiDate(f.properties.time);
                            depth = parseFloat(f.properties.depth || f.geometry?.coordinates?.[2] || 0);
                        } 
                        else {
                            lat = parseFloat(f.geojson?.coordinates?.[1] ?? f.lat ?? f.latitude);
                            lng = parseFloat(f.geojson?.coordinates?.[0] ?? f.lng ?? f.longitude);
                            id = sourceName.charAt(0) + '_' + (f.earthquake_id || f._id || `${f.date}-${f.mag}`); 
                            mag = parseFloat(f.mag) || 0; 
                            place = titleCase(f.title || "Bilinmeyen Konum"); 
                            time = parseApiDate(f.date); 
                            depth = parseFloat(f.depth || 0);
                        }

                        return { id, source: sourceName, mag, place, time, depth, lat, lng };
                    } catch (e) { return null; }
                }).filter(e => e !== null && !isNaN(e.lat) && !isNaN(e.lng) && e.lat !== 0 && e.lng !== 0);
            };

            // Parse ve Birle≈ütirme
            allEqs.push(...parseData(bdtimRes, 'BDTIM'));
            allEqs.push(...parseData(afadRes, 'AFAD'));
            allEqs.push(...parseData(usgsRes, 'USGS'));
            allEqs.push(...parseData(emscRes, 'EMSC'));
            allEqs.push(...parseData(geonetRes, 'GEONET'));

            const now = Date.now();
            if(timeFilter === 'all_hour') allEqs = allEqs.filter(e => (now - e.time) < 3600000);
            else if (timeFilter === 'all_day') allEqs = allEqs.filter(e => (now - e.time) < 86400000);
            else if (timeFilter === 'all_week') allEqs = allEqs.filter(e => (now - e.time) < 604800000);

            // B√ñLGESEL Fƒ∞LTRELEME
            const regVal = regionSelect.value;
            if(regionBounds[regVal]) {
                const bounds = regionBounds[regVal];
                allEqs = allEqs.filter(e => e.lat >= bounds.minLat && e.lat <= bounds.maxLat && e.lng >= bounds.minLng && e.lng <= bounds.maxLng);
            } else if (regVal === 'local' && userLocation) {
                allEqs = allEqs.filter(e => getDistance(userLocation.lat, userLocation.lng, e.lat, e.lng) <= 200);
            }

            // METƒ∞N ARAMA Fƒ∞LTRESƒ∞
            const searchVal = searchInput.value.trim().toLowerCase();
            if (searchVal) {
                allEqs = allEqs.filter(e => e.place.toLowerCase().includes(searchVal));
            }

            // KAYNAK Fƒ∞LTRESƒ∞
            const sFilter = sourceSelect.value;
            if(sFilter !== 'all') allEqs = allEqs.filter(e => e.source.toLowerCase().includes(sFilter));

            allEqs.sort((a,b) => b.time - a.time);

            // M√úKERRER DEPREM Bƒ∞RLE≈ûTƒ∞Rƒ∞Cƒ∞Sƒ∞
            let deduplicated =[];
            for (let eq of allEqs) {
                let existing = deduplicated.find(u => Math.abs(u.time - eq.time) < 60000 && getDistance(u.lat, u.lng, eq.lat, eq.lng) < 50);
                if (!existing) { deduplicated.push({ ...eq, mergedIds:[eq.id] }); } 
                else {
                    if(!existing.source.includes(eq.source)) {
                        existing.source += ' & ' + eq.source;
                        existing.mag = Math.max(existing.mag, eq.mag);
                        existing.mergedIds.push(eq.id);
                    }
                }
            }

            let newEqs =[];
            for(let eq of deduplicated) {
                let isSeen = eq.mergedIds.some(id => seenIds.has(id));
                if(!isSeen && !isInit) newEqs.push(eq);
                eq.mergedIds.forEach(id => seenIds.add(id));
            }

            renderData(deduplicated, isInit);

            if(!isInit && newEqs.length > 0) {
                const threshold = parseFloat(minMagInput.value);
                const alarmingEqs = newEqs.filter(e => e.mag >= threshold);
                if(alarmingEqs.length > 0) triggerAlarm(alarmingEqs.sort((a,b) => b.mag - a.mag)[0]);
            }
            
            document.getElementById('statusText').innerText = "Sistem √áevrimi√ßi";
            document.getElementById('statusText').style.color = "var(--text-muted)";
            document.getElementById('statusDot').style.backgroundColor = "var(--success)";
            document.getElementById('statusDot').style.boxShadow = "0 0 10px var(--success)";

        } catch(err) {
            console.error("MuG√∂l Tespit Hatasƒ±:", err);
            if(isInit) eqListEl.innerHTML = '<div style="text-align:center; padding:50px 20px; color:var(--danger); font-weight:700;">Baƒülantƒ± Sorunu, Sunucuya Tekrar Eri≈üiliyor...</div>';
            document.getElementById('statusText').innerText = "Baƒülantƒ± Koptu, Yeniden Deneniyor...";
            document.getElementById('statusText').style.color = "var(--danger)";
            document.getElementById('statusDot').style.backgroundColor = "var(--danger)";
            document.getElementById('statusDot').style.boxShadow = "0 0 10px var(--danger)";
        }
    }

    // --- YENƒ∞LEME √áUBUƒûU (PROGRESS BAR) ---
    let progress = 0;
    const updateInterval = 60000;
    
    function startProgress() {
        const bar = document.getElementById('progressBar');
        setInterval(() => {
            progress += 1000;
            const percentage = (progress / updateInterval) * 100;
            bar.style.width = percentage + '%';
            
            if (progress >= updateInterval) {
                progress = 0;
                bar.style.width = '0%';
                fetchEarthquakes(false);
            }
        }, 1000);
    }

    window.onload = () => {
        fetchEarthquakes(true);
        startProgress();
    };

</script>
</body>
</html>